# 🏗️ BarbellGPT 系统架构设计

## 一、架构概述

BarbellGPT 是一个基于 RAG（检索增强生成）技术的力量举训练智能助手，采用模块化、可扩展的架构设计，专注于力量举领域的专业知识问答和训练指导。

### 核心架构原则
- **模块化设计**：各组件职责清晰，松耦合高内聚
- **可扩展性**：支持新功能模块的平滑集成
- **中文优化**：针对中文力量举术语和表达优化
- **LangGraph驱动**：基于 LangGraph 构建有状态代理系统
- **LangSmith监控**：完整的调试、监控与评估体系

## 二、系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    BarbellGPT 系统架构                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │   用户界面层     │    │   应用入口层     │                │
│  │   (UI Layer)    │    │  (Entry Layer)  │                │
│  │                 │    │                 │                │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │                │
│  │ │Streamlit UI │ │    │ │   main.py   │ │                │
│  │ │ChatInterface│ │    │ │   cli.py    │ │                │
│  │ └─────────────┘ │    │ │   run.py    │ │                │
│  └─────────────────┘    └─────────────────┘                │
│           │                       │                        │
│           └───────────────────────┼────────────────────────┘
│                                   │                        │
│  ┌─────────────────────────────────┼────────────────────────┐
│  │           代理层 (Agent Layer)   │                        │
│  │                                 │                        │
│  │  ┌─────────────────────────────┐ │                        │
│  │  │        RAGAgent            │ │                        │
│  │  │  ┌─────────────────────┐   │ │                        │
│  │  │  │ ConversationManager │   │ │                        │
│  │  │  └─────────────────────┘   │ │                        │
│  │  └─────────────────────────────┘ │                        │
│  └─────────────────────────────────┼────────────────────────┘
│                                   │                        │
│  ┌─────────────────────────────────┼────────────────────────┐
│  │           核心层 (Core Layer)    │                        │
│  │                                 │                        │
│  │  ┌─────────────┐ ┌─────────────┐ │                        │
│  │  │LLMManager   │ │HybridRetriever│ │                        │
│  │  │             │ │             │ │                        │
│  │  └─────────────┘ └─────────────┘ │                        │
│  │         │               │        │                        │
│  │  ┌─────────────┐ ┌─────────────┐ │                        │
│  │  │VectorStore  │ │  LangGraph  │ │                        │
│  │  │(ChromaDB)   │ │  Workflow   │ │                        │
│  │  └─────────────┘ └─────────────┘ │                        │
│  └─────────────────────────────────┼────────────────────────┘
│                                   │                        │
│  ┌─────────────────────────────────┼────────────────────────┐
│  │         知识处理层 (Knowledge)   │                        │
│  │                                 │                        │
│  │  ┌─────────────┐ ┌─────────────┐ │                        │
│  │  │DocumentLoader│ │TextProcessor│ │                        │
│  │  │             │ │             │ │                        │
│  │  └─────────────┘ └─────────────┘ │                        │
│  │         │               │        │                        │
│  │  ┌─────────────┐ ┌─────────────┐ │                        │
│  │  │ Vectorizer  │ │  Data Store │ │                        │
│  │  │             │ │             │ │                        │
│  │  └─────────────┘ └─────────────┘ │                        │
│  └─────────────────────────────────┼────────────────────────┘
│                                   │                        │
│  ┌─────────────────────────────────┼────────────────────────┐
│  │           基础设施层             │                        │
│  │                                 │                        │
│  │  ┌─────────────┐ ┌─────────────┐ │                        │
│  │  │   Config    │ │   Utils     │ │                        │
│  │  │             │ │             │ │                        │
│  │  └─────────────┘ └─────────────┘ │                        │
│  │         │               │        │                        │
│  │  ┌─────────────┐ ┌─────────────┐ │                        │
│  │  │   Logging    │ │   Testing   │ │                        │
│  │  │             │ │             │ │                        │
│  │  └─────────────┘ └─────────────┘ │                        │
│  └─────────────────────────────────┴────────────────────────┘
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                    外部服务                              │ │
│  │                                                         │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐ │ │
│  │  │阿里云百炼API │ │ChromaDB     │ │LangSmith            │ │ │
│  │  │(LLM+向量)   │ │(向量存储)   │ │(监控调试)           │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 三、核心组件详解

### 3.1 代理层 (Agent Layer)

#### RAGAgent
- **职责**：RAG 检索增强生成的核心代理
- **功能**：
  - 基于 LangGraph 构建有状态工作流
  - 协调检索、生成、对话管理
  - 处理力量举专业问答
- **关键方法**：
  - `chat()` - 主要对话接口
  - `_retrieve_node()` - 检索节点
  - `_generate_node()` - 生成节点

#### ConversationManager
- **职责**：对话历史管理和上下文维护
- **功能**：
  - 维护多轮对话状态
  - 管理对话历史长度
  - 提供对话摘要和上下文

### 3.2 核心层 (Core Layer)

#### LLMManager
- **职责**：大语言模型管理
- **功能**：
  - 连接阿里云百炼 API
  - 处理提示工程
  - 管理模型参数和响应
- **支持**：单次生成、批量生成、模板生成

#### HybridRetriever
- **职责**：混合检索策略
- **功能**：
  - 结合向量搜索和关键词搜索
  - 智能结果融合和排序
  - 支持元数据过滤
- **优势**：提高检索准确性和召回率

#### ChromaVectorStore
- **职责**：向量数据库管理
- **功能**：
  - 文档向量存储和检索
  - 相似度搜索
  - 集合管理和统计
- **特点**：持久化存储，支持增量更新

### 3.3 知识处理层 (Knowledge Layer)

#### DocumentLoader
- **职责**：文档加载和预处理
- **支持格式**：PDF、TXT、DOCX、MD
- **功能**：
  - 自动文档发现
  - 格式转换
  - 元数据提取

#### TextProcessor
- **职责**：文本处理和分块
- **功能**：
  - 文本清洗和标准化
  - 智能分块策略
  - 中文优化处理
- **配置**：可调节分块大小和重叠

#### Vectorizer
- **职责**：文本向量化
- **功能**：
  - 支持本地模型和云端 API
  - 批量向量化处理
  - 向量相似度计算
- **模型**：text-embedding-v4 (阿里云百炼)

### 3.4 用户界面层 (UI Layer)

#### ChatInterface
- **技术**：Streamlit
- **功能**：
  - 实时聊天界面
  - 对话历史展示
  - 响应式设计
- **特点**：简洁直观，支持中文交互

## 四、数据流设计

### 4.1 问答流程
```
用户输入 → 向量化 → 检索相关文档 → 构建上下文 → LLM生成 → 返回回答
```

### 4.2 知识库构建流程
```
文档上传 → 文本处理 → 分块 → 向量化 → 存储到ChromaDB → 建立索引
```

### 4.3 LangGraph工作流
```
START → retrieve_node → generate_node → END
```

## 五、技术栈

### 5.1 核心框架
- **LangChain 0.2.0+**：LLM应用开发框架
- **LangGraph**：有状态代理构建
- **LangSmith**：调试、监控、评估
- **Streamlit**：Web界面框架

### 5.2 向量和存储
- **ChromaDB**：向量数据库
- **SentenceTransformers**：本地向量模型
- **阿里云百炼**：云端LLM和向量服务

### 5.3 数据处理
- **PyPDF2/Unstructured**：文档解析
- **NumPy**：数值计算
- **Loguru**：日志管理

## 六、配置管理

### 6.1 环境变量
```bash
# 阿里云百炼配置
DASHSCOPE_API_KEY=your_api_key
DASHSCOPE_MODEL_NAME=qwen-plus

# LangSmith配置
LANGCHAIN_API_KEY=your_langsmith_key
LANGCHAIN_PROJECT=barbellgpt

# 向量模型配置
VECTOR_MODEL_NAME=text-embedding-v4
VECTOR_MODEL_PROVIDER=dashscope

# 应用配置
DEBUG=True
APP_PORT=8501
```

### 6.2 目录结构
```
BarbellGPT/
├── agents/          # 代理层
├── core/           # 核心组件
├── knowledge/      # 知识处理
├── ui/             # 用户界面
├── data/           # 数据存储
├── logs/           # 日志文件
├── tests/          # 测试代码
├── docs/           # 文档
└── config.py       # 配置管理
```

## 七、扩展性设计

### 7.1 模块化扩展
- **新代理类型**：继承基础代理类
- **新检索器**：实现统一检索接口
- **新向量模型**：支持不同向量化策略
- **新UI框架**：可替换Streamlit

### 7.2 功能扩展路径
- **V2**：训练计划推荐
- **V3**：训练日志分析
- **V4**：个性化教练

### 7.3 性能优化
- **缓存机制**：向量和检索结果缓存
- **批量处理**：文档和向量批量处理
- **异步处理**：非阻塞操作

## 八、监控和调试

### 8.1 LangSmith集成
- **调用链追踪**：完整的执行链路
- **性能监控**：响应时间和资源使用
- **错误诊断**：详细的错误信息

### 8.2 日志系统
- **结构化日志**：JSON格式日志
- **分级记录**：DEBUG、INFO、WARNING、ERROR
- **日志轮转**：自动文件轮转和清理

## 九、部署架构

### 9.1 开发环境
- **本地开发**：Python虚拟环境
- **依赖管理**：requirements.txt + uv.lock
- **配置管理**：环境变量 + config.py

### 9.2 生产环境
- **容器化**：Docker支持
- **服务化**：微服务架构准备
- **监控**：健康检查和指标收集

## 十、安全考虑

### 10.1 API安全
- **密钥管理**：环境变量存储
- **访问控制**：API密钥轮换
- **请求限制**：频率限制

### 10.2 数据安全
- **本地存储**：敏感数据本地化
- **数据加密**：传输和存储加密
- **隐私保护**：用户数据匿名化

---

*本架构设计遵循模块化、可扩展、中文优化的原则，为BarbellGPT的持续发展提供坚实基础。* 